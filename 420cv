#!/usr/bin/env python3
import os
import sys
import subprocess
import glob
from pathlib import Path

class VideoConverter:
    def __init__(self):
        self.formats = ["mp4", "avi", "mov", "mkv", "webm", "flv", "wmv", "m4v", "3gp", "ogv", "ts", "vob", "asf", "rm", "rmvb", "f4v"]
        
    def show_banner(self):
        banner = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ¬ 420CV - FAST CONVERT ğŸ¬             â•‘
â•‘                                                           â•‘
â•‘              Interactive Video Converter Shell            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """
        print(banner)
    
    def show_help(self):
        help_text = """
ğŸš€ COMMANDS:
  video.avi mp4                         # Convert to MP4
  movie.mov webm                        # Convert to WebM  
  batch *.mp4 avi                       # Convert all MP4 to AVI
  formats                               # Show formats
  help                                  # Show this help
  exit                                  # Exit 420cv

ğŸ¯ FORMATS: mp4, avi, mov, mkv, webm, flv, wmv, m4v, 3gp, ogv, ts
        """
        print(help_text)
    
    def show_formats(self):
        print("\nğŸ¯ POPULAR: mp4 (best), avi (quality), mov (apple), mkv (open), webm (web)")
        print("ğŸ“± MOBILE: 3gp, m4v, f4v")
        print("ğŸŒ WEB: flv, ogv, ts")
        print("ğŸ’» LEGACY: wmv, asf, rm, rmvb, vob")
    
    def convert_video(self, input_file, output_file):
        if not os.path.exists(input_file):
            print(f"âŒ File not found: {input_file}")
            return False
        
        print(f"ğŸ”„ Converting: {input_file} â†’ {output_file}")
        
        try:
            cmd = ["ffmpeg", "-i", input_file, "-y", output_file, "-loglevel", "error", "-stats"]
            result = subprocess.run(cmd)
            
            if result.returncode == 0:
                size = os.path.getsize(output_file) / (1024*1024)
                print(f"âœ… Done! Size: {size:.1f}MB â†’ {output_file}")
                return True
            else:
                print("âŒ Conversion failed!")
                return False
                
        except FileNotFoundError:
            print("âŒ ffmpeg not found! Install: sudo pacman -S ffmpeg")
            return False
    
    def batch_convert(self, pattern, output_format):
        files = glob.glob(pattern)
        
        if not files:
            print(f"âŒ No files found: {pattern}")
            return
        
        print(f"ğŸ”„ Converting {len(files)} files to {output_format.upper()}")
        
        success = 0
        for i, file in enumerate(files, 1):
            input_path = Path(file)
            output_file = f"{input_path.stem}_converted.{output_format}"
            
            print(f"[{i}/{len(files)}] {input_path.name}")
            
            if self.convert_video(file, output_file):
                success += 1
        
        print(f"ğŸ‰ Complete! {success}/{len(files)} converted")
    
    def parse_command(self, cmd):
        parts = cmd.strip().split()
        
        if not parts:
            return
        
        if parts[0] == "help":
            self.show_help()
        elif parts[0] == "formats":
            self.show_formats()
        elif parts[0] == "exit":
            print("ğŸ‘‹ Goodbye!")
            return False
        elif parts[0] == "batch" and len(parts) >= 3:
            self.batch_convert(parts[1], parts[2])
        elif len(parts) >= 2:
            input_file = parts[0]
            second_arg = parts[1]
            
            if second_arg.lower() in self.formats:
                input_path = Path(input_file)
                output_file = f"{input_path.stem}_converted.{second_arg}"
            else:
                output_file = second_arg
            
            self.convert_video(input_file, output_file)
        else:
            print("âŒ Usage: <input> <format> | batch <pattern> <format> | help | exit")
        
        return True
    
    def run_interactive(self):
        self.show_banner()
        self.show_help()
        
        while True:
            try:
                cmd = input("\n420cv> ").strip()
                if not self.parse_command(cmd):
                    break
            except KeyboardInterrupt:
                print("\nğŸ‘‹ Goodbye!")
                break
            except EOFError:
                print("\nğŸ‘‹ Goodbye!")
                break

if __name__ == "__main__":
    converter = VideoConverter()
    converter.run_interactive()
